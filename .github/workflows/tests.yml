name: Test Digit Counter

on:
  - push

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build
    outputs:
      github-tag: ${{ steps.define-tags.outputs.github-tag }}
      image-tag: ${{ steps.define-tags.outputs.image-tag }}
      branch-tag: ${{ steps.define-tags.outputs.branch-tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Inject slugs
        uses: rlespinasse/github-slug-action@v3.x

      - name: Define tags
        id: define-tags
        run: |
          echo "::set-output name=github-tag::${GITHUB_SHA_SHORT}"
          echo "::set-output name=image-tag::sha-${{ github.sha }}"
          echo "::set-output name=branch-tag::sha-${GITHUB_REF_SLUG}-${GITHUB_SHA_SHORT}"

      - name: Log in to GHCR
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push to GHCR
        env:
          fake: ${{ secrets.FAKE_SECRET }}
        run: |
          export DOCKER_BUILDKIT=1
          export GITHUB_IMAGE=ghcr.io/a-forsythe/digit-counter:${{ steps.define-tags.outputs.github-tag }}
          echo "version='${{ steps.define-tags.outputs.image-tag }}'" > src/__version__.py
          docker build --secret id=fake --tag $GITHUB_IMAGE .
          docker push $GITHUB_IMAGE

  test:
    runs-on: ubuntu-latest
    name: Test
    needs:
      - build
    services:
      redis:
        image: redis:6.2-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 2s
          --health-timeout 5s
          --health-retries 25
        ports:
          - "6379:6379"
    container:
      image: ghcr.io/a-forsythe/digit-counter:${{ needs.build.outputs.github-tag }}
      env:
        ENV: test
        REDIS_URL: redis://redis:6379/0
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Test
        working-directory: /usr/app
        run: python -m pytest tests --junit-xml=/usr/test-artifacts/test-results.xml

      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v1
        if: always()
        with:
          files: /usr/test-artifacts/test-results.xml

  promote-image:
    runs-on: ubuntu-latest
    name: Promote Image
    needs:
      - build
      - test
    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull and tag
        env:
          SOME_REGISTRY: someregistry.test
          SOME_REPOSITORY: digit-counter
        run: |
          export GITHUB_IMAGE=ghcr.io/a-forsythe/digit-counter:${{ needs.build.outputs.github-tag }}
          export SOME_IMAGE_COMMIT_TAGGED=${SOME_REGISTRY}/${SOME_REPOSITORY}:${{ needs.build.outputs.image-tag }}
          export SOME_IMAGE_BRANCH_TAGGED=${SOME_REGISTRY}/${SOME_REPOSITORY}:${{ needs.build.outputs.branch-tag }}
          echo "GITHUB_IMAGE=${GITHUB_IMAGE}"
          echo "SOME_IMAGE_COMMIT_TAGGED=${SOME_IMAGE_COMMIT_TAGGED}"
          echo "SOME_IMAGE_BRANCH_TAGGED=${SOME_IMAGE_BRANCH_TAGGED}"
